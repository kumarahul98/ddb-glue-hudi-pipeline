AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub:
        - ${AWS::StackName}-${RandomGUID}
        - RandomGUID:
            Fn::Select:
            - 0
            - Fn::Split:
              - '-'
              - Fn::Select:
                - 2
                - Fn::Split:
                  - /
                  - Ref: AWS::StackId
  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-DynamoDBTable
      AttributeDefinitions:
      - AttributeName: PK
        AttributeType: S
      - AttributeName: SK
        AttributeType: S
      KeySchema:
      - AttributeName: PK
        KeyType: HASH
      - AttributeName: SK
        KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      KinesisStreamSpecification:
        ApproximateCreationDateTimePrecision: MILLISECOND
        StreamArn:
          Fn::GetAtt:
          - KinesisStream
          - Arn
  KinesisStream:
    Type: AWS::Kinesis::Stream
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-KinesisStream
      ShardCount: 1
  GlueJobRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: glue.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
      - PolicyName: GlueJobS3KinesisDDBPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:*
            Resource:
            - Fn::Sub: arn:aws:s3:::${S3Bucket}/*
          - Effect: Allow
            Action:
            - kinesis:*
            Resource:
              Fn::GetAtt:
              - KinesisStream
              - Arn
      - PolicyName: AllowIAMActions
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - iam:PassRole
            Resource:
              Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*
  GlueJob:
    Type: AWS::Glue::Job
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-GlueJob
      Role:
        Fn::GetAtt:
        - GlueJobRole
        - Arn
      Command:
        Name: gluestreaming
        ScriptLocation:
          Fn::Sub: s3://${S3Bucket}/scripts/glue-job-script.py
        PythonVersion: 3
      DefaultArguments:
        --enable-continuous-cloudwatch-log: true
        --enable-metrics: true
        --S3_BUCKET_NAME:
          Ref: S3Bucket
      GlueVersion: '4.0'
      WorkerType: G.025X
      NumberOfWorkers: 2
      MaxRetries: 0
  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId:
        Ref: AWS::AccountId
      DatabaseInput:
        Name:
          Fn::Sub: ddb_streaming_glue_database
        Description: Glue database
  GlueTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId:
        Ref: AWS::AccountId
      DatabaseName:
        Ref: GlueDatabase
      TableInput:
        Name:
          Fn::Sub: ddb_streaming_glue_table
        Description: Glue table with Kinesis
        StorageDescriptor:
          Location:
            Ref: GlueDatabase
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            streamARN:
              Fn::GetAtt:
              - KinesisStream
              - Arn
            typeOfData: kinesis
          SerdeInfo:
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
        Parameters:
          classification: json
        TableType: EXTERNAL_TABLE
Outputs:
  S3BucketName:
    Description: Name of the S3 bucket
    Value:
      Ref: S3Bucket
  DynamoDBTableName:
    Description: Name of the DynamoDB table
    Value:
      Ref: DynamoDBTable
  KinesisStreamName:
    Description: Name of the Kinesis Stream
    Value:
      Ref: KinesisStream
  GlueJobName:
    Description: Name of the Glue Job
    Value:
      Ref: GlueJob
